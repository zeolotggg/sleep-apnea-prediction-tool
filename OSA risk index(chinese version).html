<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sleep Apnea Risk Prediction Tool</title>
  <meta name="description" content="Nomogram-driven sleep apnea risk tool with pixel-accurate scoring"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;color:#333;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .header{text-align:center;color:#fff;margin-bottom:30px}
    .header h1{font-size:2.2rem;margin-bottom:10px;font-weight:300}
    .header p{font-size:1.05rem;opacity:.9;max-width:720px;margin:0 auto 18px}
    .citation-info{background:rgba(255,255,255,.1);padding:12px 16px;border-radius:10px;margin:0 auto 20px;backdrop-filter:blur(10px);max-width:900px}
    .main-container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
    .content-grid{display:grid;grid-template-columns:1fr 1fr;min-height:600px}
    .input-panel{padding:40px;background:#f8f9fa;border-right:1px solid #e9ecef}
    .result-panel{padding:40px;background:#fff}
    .panel-title{font-size:1.4rem;margin-bottom:26px;color:#495057;text-align:center;font-weight:600}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-weight:600;color:#495057;font-size:.95rem}
    .form-input{width:100%;padding:12px 16px;border:2px solid #dee2e6;border-radius:10px;font-size:1rem;transition:all .3s;background:#fff}
    .form-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .input-description{font-size:.8rem;color:#6c757d;margin-top:4px}
    .predict-button{width:100%;padding:14px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;font-size:1.05rem;font-weight:600;cursor:pointer;transition:all .3s;margin-top:10px}
    .predict-button:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.3)}
    .sample-button{width:100%;padding:12px;background:transparent;color:#667eea;border:2px solid #667eea;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .3s;margin-top:12px}
    .sample-button:hover{background:#667eea;color:#fff}
    .result-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:24px;border-radius:15px;text-align:center;margin-bottom:24px}
    .risk-level{font-size:1.7rem;font-weight:700;margin-bottom:6px}
    .risk-description{font-size:1rem;opacity:.92}
    .points-section{background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:18px}
    .points-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e9ecef}
    .points-label{font-weight:500;color:#495057}
    .points-value{font-weight:700;color:#667eea}
    .total-points{border-top:2px solid #667eea;margin-top:10px;padding-top:10px;font-size:1.05rem}
    .probability-section{margin-bottom:22px}
    .probability-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #e9ecef}
    .probability-label{font-weight:600;color:#495057}
    .probability-value{font-weight:700}
    .chart-container{background:#f8f9fa;padding:20px;border-radius:10px}
    .chart-title{text-align:center;margin-bottom:12px;font-weight:600;color:#495057}
    .bar-chart{display:flex;height:200px;gap:28px;align-items:end;justify-content:center}
    .chart-bar{background:linear-gradient(180deg,#667eea,#764ba2);border-radius:8px 8px 0 0;min-width:100px;position:relative;transition:all .3s;cursor:pointer}
    .chart-bar:hover{opacity:.85;transform:scale(1.02)}
    .bar-value{position:absolute;top:-28px;width:100%;text-align:center;font-weight:700;color:#495057}
    .bar-label{position:absolute;bottom:-22px;width:100%;text-align:center;font-size:.9rem;color:#6c757d;font-weight:600}
    .footer-info{background:#f8f9fa;padding:16px;text-align:center;font-size:.9rem;color:#6c757d;border-top:1px solid #e9ecef}
    .disclaimer{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:12px;border-radius:10px;margin-top:14px;font-size:.9rem}
    @media (max-width:768px){.content-grid{grid-template-columns:1fr}.input-panel{border-right:none;border-bottom:1px solid #e9ecef}.header h1{font-size:1.8rem}}
  </style>
</head>
<body>
  <div class="header">
    <h1>Sleep Apnea Risk Prediction Tool</h1>
    <p>Nomogram-based prediction (pixel-accurate to your latest figure)</p>
    <div class="citation-info">
      本工具直接依据你提供的最新 nomogram（/mnt/data/图片1.png），按<strong>各轴的实际像素长度</strong>线性插值计算 Points 与 Risk。
    </div>
  </div>

  <div class="main-container">
    <div class="content-grid">
      <div class="input-panel">
        <h2 class="panel-title">Patient Information</h2>

        <div class="form-group">
          <label class="form-label" for="gender">Gender</label>
          <select class="form-input" id="gender">
            <option value="1">Male</option>
            <option value="0">Female</option>
          </select>
          <div class="input-description">Nomogram 标注：female=2（左端），male=1（右端）</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="age">Age (years)</label>
          <input type="number" class="form-input" id="age" value="50" min="10" max="120" step="1"/>
          <div class="input-description">轴范围：10–120</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="height">Height (cm)</label>
          <input type="number" class="form-input" id="height" value="175" min="140" max="200" step="0.1"/>
          <div class="input-description">轴范围：200 → 140（从左到右数值递减）</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="weight">Weight (kg)</label>
          <input type="number" class="form-input" id="weight" value="85" min="20" max="200" step="0.1"/>
          <div class="input-description">轴范围：20–200</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="neck_circumference">Neck Circumference (cm)</label>
          <input type="number" class="form-input" id="neck_circumference" value="40" min="30" max="90" step="0.1"/>
          <div class="input-description">轴范围：90 → 30（从左到右数值递减）</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="bmi">BMI (kg/m²)</label>
          <input type="number" class="form-input" id="bmi" value="27.76" readonly/>
          <div class="input-description">自动由身高体重计算；轴范围：5–65</div>
        </div>

        <button class="predict-button" onclick="performPrediction()">Calculate Risk Prediction</button>
        <button class="sample-button" onclick="loadSampleData()">Load Sample Data</button>

        <div class="disclaimer">
          <strong>Disclaimer:</strong> 本工具仅用于科研/教学演示，不能替代临床诊断。
        </div>
      </div>

      <div class="result-panel">
        <h2 class="panel-title">Prediction Results</h2>

        <div class="result-card">
          <div class="risk-level" id="risk-level">Low Risk</div>
          <div class="risk-description" id="risk-description">
            Based on the provided measurements, the patient shows low risk for sleep apnea.
          </div>
        </div>

        <div class="points-section">
          <h3 style="margin-bottom:12px;color:#495057;">Nomogram Point Breakdown</h3>
          <div class="points-item"><span class="points-label">Gender Points:</span><span class="points-value" id="gender-points">0.00</span></div>
          <div class="points-item"><span class="points-label">Age Points:</span><span class="points-value" id="age-points">0.00</span></div>
          <div class="points-item"><span class="points-label">BMI Points:</span><span class="points-value" id="bmi-points">0.00</span></div>
          <div class="points-item"><span class="points-label">Neck Circumference Points:</span><span class="points-value" id="neck-points">0.00</span></div>
          <div class="points-item"><span class="points-label">Height Points:</span><span class="points-value" id="height-points">0.00</span></div>
          <div class="points-item"><span class="points-label">Weight Points:</span><span class="points-value" id="weight-points">0.00</span></div>
          <div class="points-item total-points"><span class="points-label"><strong>Total Points:</strong></span><span class="points-value" id="total-points"><strong>0.00</strong></span></div>
        </div>

        <div class="probability-section">
          <h3 style="margin-bottom:12px;color:#495057;">Risk Assessment</h3>
          <div class="probability-item"><span class="probability-label">Predicted Risk:</span><span class="probability-value" id="risk-probability" style="color:#28a745;">5.0%</span></div>
          <div class="probability-item"><span class="probability-label">Risk Category:</span><span class="probability-value" id="risk-category" style="color:#28a745;">Low</span></div>
        </div>

        <div class="chart-container">
          <div class="chart-title">Risk Probability Visualization</div>
          <div class="bar-chart">
            <div class="chart-bar" id="bar-low" style="height:85%;">
              <div class="bar-value">95.0%</div>
              <div class="bar-label">Low Risk</div>
            </div>
            <div class="chart-bar" id="bar-high" style="height:15%;">
              <div class="bar-value">5.0%</div>
              <div class="bar-label">High Risk</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer-info">
      <p><strong>Scoring:</strong> 每个分项均由该轴的像素长度与 Points 轴长度的比值精确换算；Total Points→Risk 采用实测关键点的非线性曲线插值。</p>
      <p><strong>Last Updated:</strong> Sep 2025 | <strong>Version:</strong> 2.2.0</p>
    </div>
  </div>

  <script>
    /** ===========
     *  几何常量（来自 /mnt/data/图片1.png 逐像素测量）
     *  所有轴均以 x≈406 为左端起点，向右递增。
     *  =========== */
    const NOMO = {
      pointsLenPx: 1506, // Points 轴（0–100）真实像素长度
      // 各变量轴：数值从 left→right（有的为递减）
      axes: {
        gender: { left: 2,   right: 1,   lenPx: 111 },  // female=2 → male=1
        neck:   { left: 90,  right: 30,  lenPx: 253 },  // 90 → 30
        height: { left: 200, right: 140, lenPx: 66  },  // 200 → 140
        weight: { left: 20,  right: 200, lenPx: 257 },  // 20 → 200
        age:    { left: 10,  right: 120, lenPx: 571 },  // 10 → 120
        bmi:    { left: 5,   right: 65,  lenPx: 1505 }  // 5 → 65
      },
      // Total Points 与 Risk 轴
      totalPointsMax: 160,  // 图下方总分轴 0–160
      riskMin: 0.05,
      riskMax: 0.95
    };

    // 预计算每个变量的"最大可得分"
    const MAX_POINTS = Object.fromEntries(
      Object.entries(NOMO.axes).map(([k, ax]) => {
        const maxPts = ax.lenPx / NOMO.pointsLenPx * 100;
        return [k, maxPts];
      })
    );

    // 轴上分数（左端→右端归一化到 0→1；自动处理数值递减轴）
    function axisFraction(value, left, right) {
      const vMin = Math.min(left, right);
      const vMax = Math.max(left, right);
      const v = Math.max(vMin, Math.min(vMax, value));
      if (right > left) return (v - left) / (right - left);
      return (left - v) / (left - right); // 递减轴
    }

    // 将变量取值换算为 Points
    function valueToPoints(value, axisKey) {
      const ax   = NOMO.axes[axisKey];
      const frac = axisFraction(value, ax.left, ax.right);
      return frac * (ax.lenPx / NOMO.pointsLenPx * 100);
    }

    // 总分 → 风险（根据实际 nomogram 的非线性曲线插值）
    function totalPointsToRisk(totalPts) {
      // 实际测量的关键点 [总分, 风险]
      const keyPoints = [
        [0,  0.05],
        [32, 0.05],
        [40, 0.13],
        [47, 0.25],
        [51, 0.35],
        [56, 0.50],
        [61, 0.65],
        [65, 0.75],
        [70, 0.85],
        [80, 0.95],
        [160, 0.95]  // 外推到最大值
      ];
      
      const T = Math.max(0, Math.min(160, totalPts));
      
      // 线性插值
      for (let i = 0; i < keyPoints.length - 1; i++) {
        const [x1, y1] = keyPoints[i];
        const [x2, y2] = keyPoints[i + 1];
        
        if (T >= x1 && T <= x2) {
          if (x1 === x2) return y1;
          const ratio = (T - x1) / (x2 - x1);
          return y1 + ratio * (y2 - y1);
        }
      }
      
      // 默认返回（不应该到达这里）
      return T < 32 ? 0.05 : 0.95;
    }

    // 自动计算 BMI
    function calculateBMI() {
      const h = parseFloat(document.getElementById('height').value);
      const w = parseFloat(document.getElementById('weight').value);
      if (h && w) {
        const bmi = w / Math.pow(h / 100, 2);
        document.getElementById('bmi').value = bmi.toFixed(2);
      }
    }
    document.getElementById('height').addEventListener('input', calculateBMI);
    document.getElementById('weight').addEventListener('input', calculateBMI);

    function performPrediction() {
      const genderUI = parseInt(document.getElementById('gender').value, 10); // 1 male, 0 female
      const age      = parseFloat(document.getElementById('age').value);
      const height   = parseFloat(document.getElementById('height').value);
      const weight   = parseFloat(document.getElementById('weight').value);
      const neck     = parseFloat(document.getElementById('neck_circumference').value);
      const bmi      = parseFloat(document.getElementById('bmi').value);

      if ([age, height, weight, neck, bmi].some(v => Number.isNaN(v))) {
        alert('Please fill in all fields with valid numbers.'); return;
      }

      // gender 取值转换为图上的 1/2
      const genderVal = (genderUI === 1) ? 1 : 2;

      // 逐项得分（像素级线性插值）
      const genderPts = valueToPoints(genderVal, 'gender');
      const agePts    = valueToPoints(age,    'age');
      const bmiPts    = valueToPoints(bmi,    'bmi');
      const neckPts   = valueToPoints(neck,   'neck');
      const heightPts = valueToPoints(height, 'height');
      const weightPts = valueToPoints(weight, 'weight');

      const totalPts = genderPts + agePts + bmiPts + neckPts + heightPts + weightPts;
      const riskProb = totalPointsToRisk(totalPts);

      updateResults(genderPts, agePts, bmiPts, neckPts, heightPts, weightPts, totalPts, riskProb);
    }

    function updateResults(genderPts, agePts, bmiPts, neckPts, heightPts, weightPts, totalPts, riskProb) {
      const fmt = x => x.toFixed(2);

      // 分项
      document.getElementById('gender-points').textContent = fmt(genderPts);
      document.getElementById('age-points').textContent    = fmt(agePts);
      document.getElementById('bmi-points').textContent    = fmt(bmiPts);
      document.getElementById('neck-points').textContent   = fmt(neckPts);
      document.getElementById('height-points').textContent = fmt(heightPts);
      document.getElementById('weight-points').textContent = fmt(weightPts);

      // 总分（用于风险映射的裁剪值提示）
      const clipped = Math.min(NOMO.totalPointsMax, Math.max(0, totalPts));
      const totalText = (clipped === totalPts) ? fmt(totalPts) : `${fmt(totalPts)} (used: ${fmt(clipped)})`;
      document.getElementById('total-points').textContent = totalText;

      // 风险显示
      const pct = (riskProb * 100).toFixed(1);
      document.getElementById('risk-probability').textContent = `${pct}%`;

      const riskLevel = document.getElementById('risk-level');
      const riskDesc  = document.getElementById('risk-description');
      const riskCat   = document.getElementById('risk-category');

      let category, color, cardColor, description;
      if (riskProb < 0.15) {
        category='Low';   color='#28a745'; cardColor='linear-gradient(135deg,#27ae60 0%,#229954 100%)';
        description='Based on the nomogram analysis, the patient shows low risk for sleep apnea.';
      } else if (riskProb < 0.50) {
        category='Moderate'; color='#ffc107'; cardColor='linear-gradient(135deg,#f39c12 0%,#e67e22 100%)';
        description='Based on the nomogram analysis, the patient shows moderate risk for sleep apnea. Consider further evaluation.';
      } else {
        category='High'; color='#dc3545'; cardColor='linear-gradient(135deg,#e74c3c 0%,#c0392b 100%)';
        description='Based on the nomogram analysis, the patient shows high risk for sleep apnea. Further evaluation is recommended.';
      }
      riskLevel.textContent = `${category} Risk`;
      riskCat.textContent   = category;
      riskDesc.textContent  = description;
      riskLevel.parentElement.style.background = cardColor;
      document.getElementById('risk-probability').style.color = color;
      document.getElementById('risk-category').style.color = color;

      // 柱图
      const barLow  = document.getElementById('bar-low');
      const barHigh = document.getElementById('bar-high');
      const lowH  = Math.max((1 - riskProb) * 100, 5);
      const highH = Math.max(riskProb * 100, 5);
      barLow.style.height  = `${lowH}%`;
      barHigh.style.height = `${highH}%`;
      barLow.querySelector('.bar-value').textContent  = `${(100 - parseFloat(pct)).toFixed(1)}%`;
      barHigh.querySelector('.bar-value').textContent = `${pct}%`;

      if (riskProb >= 0.50) {
        barHigh.style.background='linear-gradient(180deg,#e74c3c,#c0392b)';
        barLow.style.background ='linear-gradient(180deg,#95a5a6,#7f8c8d)';
      } else if (riskProb >= 0.15) {
        barHigh.style.background='linear-gradient(180deg,#f39c12,#e67e22)';
        barLow.style.background ='linear-gradient(180deg,#27ae60,#229954)';
      } else {
        barLow.style.background ='linear-gradient(180deg,#27ae60,#229954)';
        barHigh.style.background='linear-gradient(180deg,#95a5a6,#7f8c8d)';
      }
    }

    function loadSampleData() {
      const samples = [
        { gender:1, age:55, height:170, weight:95,  neck:45 }, // 中-高
        { gender:0, age:35, height:165, weight:60,  neck:32 }, // 低
        { gender:1, age:65, height:175, weight:110, neck:48 }, // 高
        { gender:0, age:45, height:170, weight:75,  neck:38 }, // 中
        { gender:1, age:25, height:180, weight:70,  neck:38 }  // 低-中
      ];
      const s = samples[Math.floor(Math.random()*samples.length)];
      document.getElementById('gender').value = s.gender;
      document.getElementById('age').value    = s.age;
      document.getElementById('height').value = s.height;
      document.getElementById('weight').value = s.weight;
      document.getElementById('neck_circumference').value = s.neck;
      calculateBMI();
      setTimeout(performPrediction, 30);
    }

    // 初始化
    calculateBMI();
    performPrediction();
  </script>
</body>
</html>
